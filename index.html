<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Habit Tracker â€” Everydayâ€‘style Chain</title>
  <link rel="icon" href="data:," />
  <style>
    :root{
      /* Light theme (default) */
      --bg: #f6f7fb;
      --panel: #ffffff;
      --panel-2: #fbfcff;
      --text: #0f172a;
      --muted: #64748b;
      --accent: #6b8cff; /* for generic buttons */
      --grid-gap: 6px;
      --radius: 12px;
      --shadow: 0 10px 26px rgba(2,6,23,0.08);

      /* state base (fallbacks) */
      --failed: #ef4444;
      --skipped: #cbd5e1;
      --pending: #e9edf6;

      --sticky: #f3f6ff;
      --cell-size: 28px;
    }
    html[data-theme="dark"]{
      --bg: #0f1020;
      --panel: #14162b;
      --panel-2: #191b34;
      --text: #e9ecf6;
      --muted: #a7adcf;
      --failed: #ef4444;
      --skipped: #475569;
      --pending: #2a2d4f;
      --sticky: #12142a;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; background:var(--bg); color:var(--text); font:14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; overflow-x:hidden }

    .wrap{ max-width: 1400px; margin:0 auto; padding:16px; display:flex; flex-direction:column; gap:12px }

    .card{ background: linear-gradient(180deg, var(--panel), var(--panel-2)); border-radius: var(--radius); box-shadow: var(--shadow); border:1px solid rgba(2,6,23,0.06) }

    /* Toolbar */
    .toolbar{ display:flex; gap:8px; justify-content:space-between; align-items:center; padding:12px }
    .btn{ border:1px solid rgba(2,6,23,0.12); background:#fff0; color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer }
    html[data-theme="dark"] .btn{ border-color: rgba(255,255,255,0.14) }
    .btn:hover{ border-color: rgba(2,6,23,0.25) }
    .btn.primary{ background: var(--accent); border-color: var(--accent); color:white; box-shadow: 0 6px 18px rgba(107,140,255,0.35)}
    .seg{ display:flex; gap:6px; align-items:center; flex-wrap:wrap }
    .muted{ color: var(--muted) }

    /* Chain grid */
    .chain-shell{ overflow-x:hidden; overflow-y:visible; padding:8px; }
    .chain{ display:grid; grid-auto-rows: max-content; row-gap:4px; column-gap:8px }
    .sticky-col{ position:sticky; left:0; z-index:2; background: var(--sticky); border-right:1px solid rgba(2,6,23,0.06) }

    .head{ display:grid; align-items:end; gap: var(--grid-gap); }
    .head .label{ position:sticky; left:0; padding:8px 12px; border-radius:12px; background: var(--sticky); font-weight:700; z-index:3; }

    .dates{ display:grid; gap: var(--grid-gap); }
    .date-cell{ width: var(--cell-size); height: 18px; text-align:center; font-size:11px; color: var(--muted) }
    .date-cell.today{ font-weight:800 }

    .row{ display:grid; gap: var(--grid-gap); align-items:center }
    .habit-sticky{ display:grid; grid-template-columns: 10px minmax(110px, 1fr) max-content max-content auto; align-items:center; column-gap:10px; padding:6px 10px; border-radius:12px; box-shadow: inset 0 0 0 1px rgba(2,6,23,0.06); overflow:hidden }
    .swatch{ width:10px; height:10px; border-radius:4px; border:1px solid rgba(0,0,0,0.15) }
    .habit-name{ font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .tiny{ font-size:11px; color: var(--muted); white-space:nowrap }

    .cells{ display:grid; gap: var(--grid-gap); }
    .cell{ width: var(--cell-size); height: var(--cell-size); border-radius:8px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:1px solid rgba(2,6,23,0.06); transition: transform 120ms ease, box-shadow 120ms ease; background: var(--pending); }
    .cell:hover{ transform: translateY(-1px); box-shadow: 0 6px 14px rgba(2,6,23,0.15) }
    .cell.state-failed{ background: var(--failed); color:white; border-color: rgba(0,0,0,0.15) }
    .cell.state-skipped{ background: var(--skipped); color:#1f2937; border-color: rgba(0,0,0,0.1) }

    /* Today status pill */
    .pill{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid rgba(2,6,23,0.08); white-space:nowrap }
    .pill.done{ background: #d6f5e3; color:#065f46; }
    .pill.failed{ background: #fee2e2; color:#991b1b; }
    .pill.skipped{ background: #e2e8f0; color:#334155; }
    .pill.pending{ background: #eef2ff; color:#363a78; }
    html[data-theme="dark"] .pill.done{ background: #124f3c; color:#d1fae5; border-color: rgba(255,255,255,0.1) }
    html[data-theme="dark"] .pill.failed{ background: #5c1a1a; color:#fecaca; border-color: rgba(255,255,255,0.1) }
    html[data-theme="dark"] .pill.skipped{ background: #303645; color:#e2e8f0; border-color: rgba(255,255,255,0.1) }
    html[data-theme="dark"] .pill.pending{ background: #1c214a; color:#dbe4ff; border-color: rgba(255,255,255,0.1) }

    .footer{ padding:10px 12px; color: var(--muted); font-size:12px }

    @media (max-width: 780px){
      .habit-sticky{ grid-template-columns: 10px 1fr auto; row-gap:6px }
      .tiny{ display:none }
    }

    /* Modal */
    .modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.45); display:grid; place-items:center; z-index:50 }
    .modal{ width:min(520px, calc(100vw - 32px)); background:var(--panel); color:var(--text); border-radius:14px; border:1px solid rgba(2,6,23,0.08); box-shadow: var(--shadow); padding:14px }
    .modal h3{ margin:0 0 8px 0 }
    .form{ display:grid; gap:10px }
    .form .row{ display:flex; gap:10px; align-items:center }
    .form label{ color:var(--muted) }
    input[type="text"], select{ padding:8px 10px; border-radius:10px; background:#fff; color:var(--text); border:1px solid rgba(2,6,23,0.12) }
    html[data-theme="dark"] input[type="text"], html[data-theme="dark"] select{ background:#0d0f22; color:var(--text); border-color: rgba(255,255,255,0.14) }
    .modal-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:8px }
    .btn.danger{ border-color:#ef4444; color:#ef4444 }
    .btn.danger:hover{ background:#fee2e2 }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card toolbar">
      <div class="seg">
        <button id="newHabit" class="btn">ï¼‹ New Habit</button>
        <button id="exportAll" class="btn">Export</button>
        <label for="importAll" class="btn">Import</label>
        <input id="importAll" type="file" accept="application/json" hidden />
      </div>
      <div class="seg">
        <button id="prevDay" class="btn" title="Previous day (Shift = 7 days)">â—€</button>
        <button id="nextDay" class="btn" title="Next day (Shift = 7 days)">â–¶</button>
        <button id="todayBtn" class="btn">Today</button>
        <span class="muted">Window: 15d</span>
        <button id="themeToggle" class="btn">Light â†” Dark</button>
      </div>
    </header>

    <section class="card chain-shell">
      <div id="chain" class="chain"></div>
      <div class="footer">All habits visible. Click cells to cycle: pending â†’ done â†’ failed â†’ skipped â†’ (clear). Weekends auto-skip if enabled per habit. Data stored locally.</div>
    </section>
  </div>

  <script>
    // ===== Utilities =====
    const fmt = (d)=>{ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}` };
    const parse = (s)=>{ const [y,m,d] = s.split('-').map(Number); return new Date(y, m-1, d); };
    const startOfDay = (d)=> new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const addDays = (d,n)=> new Date(d.getFullYear(), d.getMonth(), d.getDate()+n);
    const isWeekend = (d)=>{ const g=d.getDay(); return g===0 || g===6; };

    // Color helpers
    function hexToRgb(hex){ const m=hex.replace('#',''); const v=parseInt(m.length===3? m.split('').map(c=>c+c).join('') : m, 16); return {r:(v>>16)&255,g:(v>>8)&255,b:v&255}; }
    function rgbToHex(r,g,b){ return '#'+[r,g,b].map(x=> x.toString(16).padStart(2,'0')).join(''); }
    function mix(hex1, hex2, w){ const a=hexToRgb(hex1), b=hexToRgb(hex2); const r=Math.round(a.r*(1-w)+b.r*w), g=Math.round(a.g*(1-w)+b.g*w), b2=Math.round(a.b*(1-w)+b.b*w); return rgbToHex(r,g,b2); }

    function shadeForStreak(baseHex, theme, level){ // level 1..4
      const wl = [0.82, 0.62, 0.42, 0.18];
      const wd = [0.55, 0.40, 0.28, 0.12];
      const w = (theme==='dark'? wd : wl)[Math.max(0, Math.min(3, level-1))];
      const bg = theme==='dark'? '#0f1020' : '#ffffff';
      return mix(baseHex, bg, w);
    }

    // ===== Storage =====
    const KEY='habitTracker_v1';
    function load(){ try{ return JSON.parse(localStorage.getItem(KEY))||null }catch{ return null } }
    function save(x){ localStorage.setItem(KEY, JSON.stringify(x)); }

    // ===== Default State =====
    const today = startOfDay(new Date());
    const defaultState = {
      selectedHabitId: null,
      habits: [ { id: crypto.randomUUID(), name: 'Daily Focus', color:'#6b8cff', createdAt: fmt(today), autoSkipWeekends: true, entries: {} } ],
      ui: { windowDays: 15, windowEndISO: fmt(today), theme: 'light' }
    };

    let state = load() || defaultState;
    if(!state.ui) state.ui = { windowDays: 15, windowEndISO: fmt(today), theme: 'light' };
    if(!('windowDays' in state.ui)) state.ui.windowDays = 15;
    if(!('windowEndISO' in state.ui)) state.ui.windowEndISO = fmt(today);
    if(!('theme' in state.ui)) state.ui.theme = 'light';

    document.documentElement.setAttribute('data-theme', state.ui.theme);

    // ===== Elements =====
    const elChain = document.getElementById('chain');
    const elNew = document.getElementById('newHabit');
    const elExport = document.getElementById('exportAll');
    const elImport = document.getElementById('importAll');
    const elTheme = document.getElementById('themeToggle');

    // Window nav
    const elPrev = document.getElementById('prevDay');
    const elNext = document.getElementById('nextDay');
    const elToday = document.getElementById('todayBtn');

    // ===== Habit helpers =====
    function currentHabits(){ return state.habits; }
    function addHabit(){ state.habits.push({ id: crypto.randomUUID(), name:'New Habit', color:'#22d3ee', createdAt: fmt(today), autoSkipWeekends:true, entries:{} }); save(state); render(); }
    function deleteHabit(id){ if(!confirm('Delete this habit? This cannot be undone.')) return; state.habits = state.habits.filter(h=>h.id!==id); save(state); render(); }

    function setEntry(h, key, val){ if(!val) delete h.entries[key]; else h.entries[key]=val; save(state); }

    function cycle(h, key, weekend){
      const cur = h.entries[key] || (weekend && h.autoSkipWeekends ? 'skipped' : 'pending');
      const order=['pending','done','failed','skipped'];
      const next=order[(order.indexOf(cur)+1)%order.length];
      if(next==='pending') delete h.entries[key]; else h.entries[key]=next;
      save(state); }

    function effective(h, date){
      const k = fmt(date); const raw = h.entries[k];
      return (!raw && isWeekend(date) && h.autoSkipWeekends) ? 'skipped' : (raw || 'pending');
    }

    function earliestConsideredDate(h){
      const keys = Object.keys(h.entries);
      if(keys.length){
        const minKey = keys.reduce((a,b)=> a < b ? a : b);
        return parse(minKey);
      }
      return parse(h.createdAt);
    }

    // ===== Stats =====
    function stats(h){
      const start = earliestConsideredDate(h);
      const end = today;
      let cur=0, best=0, total=0;
      for(let d=startOfDay(start); d<=end; d=addDays(d,1)){
        const v = effective(h,d);
        if(v==='done'){ cur++; total++; if(cur>best) best=cur; }
        else if(v==='skipped'){ /* keeps streak */ }
        else { if(d<today) cur=0; }
      }
      return { current:cur, longest:best, total };
    }

    function carryStreakBefore(h, startDate){
      // Count consecutive 'done' days immediately before startDate, skipping 'skipped'
      let cur = 0;
      const bound = earliestConsideredDate(h);
      for(let d=addDays(startDate, -1); d>=bound; d=addDays(d, -1)){
        const v = effective(h, d);
        if(v==='done'){ cur++; continue; }
        if(v==='skipped'){ continue; }
        // failed or pending (historical) breaks
        break;
      }
      return cur;
    }

    function updateTodayPill(el, h){
      const v = effective(h, today);
      el.className = 'pill '+v;
      const label = v.charAt(0).toUpperCase()+v.slice(1);
      el.textContent = `Today: ${label}`;
      el.title = 'Click to cycle status for today';
      el.onclick = ()=>{ cycle(h, fmt(today), isWeekend(today)); render(); };
    }

    // ===== Window helpers =====
    function getWindowDates(){
      const end = parse(state.ui.windowEndISO);
      const n = state.ui.windowDays;
      return Array.from({length:n}, (_,i)=> addDays(end, -(n-1-i)) );
    }
    function shiftWindow(deltaDays){
      const end = parse(state.ui.windowEndISO);
      state.ui.windowEndISO = fmt(addDays(end, deltaDays));
      save(state); render();
    }

    // ===== Modal =====
    function openHabitModal(h){
      const overlay = document.createElement('div'); overlay.className='modal-overlay'; overlay.tabIndex = -1;
      const modal = document.createElement('div'); modal.className='modal';
      modal.innerHTML = `
        <h3>Edit Habit</h3>
        <div class="form">
          <div class="row">
            <label style="min-width:90px">Name</label>
            <input id="m_name" type="text" value="${h.name.replace(/"/g,'&quot;')}" />
          </div>
          <div class="row">
            <label style="min-width:90px">Color</label>
            <select id="m_color">
              <option value="#6b8cff">Blue</option>
              <option value="#22d3ee">Cyan</option>
              <option value="#22c55e">Green</option>
              <option value="#a3e635">Lime</option>
              <option value="#f59e0b">Amber</option>
              <option value="#f472b6">Pink</option>
              <option value="#ef4444">Red</option>
              <option value="#a78bfa">Violet</option>
            </select>
          </div>
          <div class="row">
            <label style="min-width:90px">Options</label>
            <label><input id="m_skip" type="checkbox" ${h.autoSkipWeekends?'checked':''}/> Autoâ€‘skip weekends</label>
          </div>
        </div>
        <div class="modal-actions">
          <button id="m_delete" class="btn danger">Delete</button>
          <span style="flex:1"></span>
          <button id="m_cancel" class="btn">Cancel</button>
          <button id="m_save" class="btn primary">Save</button>
        </div>`;
      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      const nameI = modal.querySelector('#m_name');
      const colorI = modal.querySelector('#m_color'); colorI.value = h.color;
      const skipI = modal.querySelector('#m_skip');

      function close(){ overlay.remove(); }
      overlay.addEventListener('click', (e)=>{ if(e.target===overlay) close(); });
      document.addEventListener('keydown', function esc(e){ if(e.key==='Escape'){ close(); document.removeEventListener('keydown', esc); } });

      modal.querySelector('#m_cancel').onclick = close;
      modal.querySelector('#m_save').onclick = ()=>{
        h.name = nameI.value.trim()||'Untitled';
        h.color = colorI.value;
        h.autoSkipWeekends = !!skipI.checked;
        save(state); close(); render();
      };
      modal.querySelector('#m_delete').onclick = ()=>{ close(); deleteHabit(h.id); };

      setTimeout(()=> nameI.focus(), 0);
    }

    // ===== Render Chain =====
    function render(){
      document.documentElement.setAttribute('data-theme', state.ui.theme);

      // Dates for current window
      const dates = getWindowDates();

      // Grid columns: sticky + n cells
      const stickyW = 300; // compact to reduce gap & avoid overlap
      const gridCols = `${stickyW}px repeat(${dates.length}, var(--cell-size))`;

      elChain.innerHTML='';

      // Head row
      const head = document.createElement('div'); head.className='head'; head.style.gridTemplateColumns = gridCols;
      const label = document.createElement('div'); label.className='label sticky-col'; label.textContent='Habits'; head.appendChild(label);
      const datesWrap = document.createElement('div'); datesWrap.className='dates'; datesWrap.style.gridTemplateColumns = `repeat(${dates.length}, var(--cell-size))`;
      dates.forEach(d=>{
        const dc = document.createElement('div'); dc.className='date-cell';
        const isT = fmt(d)===fmt(today);
        dc.classList.toggle('today', isT);
        dc.title = d.toDateString();
        dc.textContent = d.getDate();
        datesWrap.appendChild(dc);
      });
      head.appendChild(datesWrap);
      elChain.appendChild(head);

      // Habit rows
      for(const h of currentHabits()){
        const row = document.createElement('div'); row.className='row'; row.style.gridTemplateColumns = gridCols;

        // sticky cell
        const sticky = document.createElement('div'); sticky.className='habit-sticky sticky-col';
        const sw = document.createElement('div'); sw.className='swatch'; sw.style.background = h.color; sticky.appendChild(sw);
        const name = document.createElement('div'); name.className='habit-name'; name.textContent = h.name; name.title=h.name; name.onclick=()=> openHabitModal(h); sticky.appendChild(name);
        const todayPill = document.createElement('span'); todayPill.className='pill'; updateTodayPill(todayPill, h); sticky.appendChild(todayPill);
        const st = stats(h);
        const tiny = document.createElement('div'); tiny.className='tiny'; tiny.textContent = `ðŸ”¥ ${st.current}  â€¢  â­ ${st.longest}  â€¢  âœ“ ${st.total}`; sticky.appendChild(tiny);
        const menu = document.createElement('button'); menu.className='btn'; menu.style.marginLeft='auto'; menu.textContent='â‹¯';
        menu.onclick = ()=> openHabitModal(h);
        sticky.appendChild(menu);
        row.appendChild(sticky);

        // cells
        const cells = document.createElement('div'); cells.className='cells'; cells.style.gridTemplateColumns = `repeat(${dates.length}, var(--cell-size))`;

        // Compute carry-over streak before the window so shading continues
        let sinceBreak = carryStreakBefore(h, dates[0]);

        dates.forEach(d=>{
          const k = fmt(d); const weekend=isWeekend(d);
          const c = document.createElement('div'); c.className='cell';
          const eff = effective(h,d);
          c.classList.add('state-'+eff);

          // Color tint = habit color, darker as streak grows
          if(eff==='done'){
            sinceBreak += 1; const level = Math.min(4, sinceBreak);
            c.style.background = shadeForStreak(h.color, state.ui.theme, level);
          } else if(eff==='skipped'){
            // streak continues
          } else if((eff==='failed') || (eff==='pending' && d < today)){
            sinceBreak = 0;
          }

          c.title = `${k} â€” ${eff}` + (eff==='skipped' && weekend && !h.entries[k] ? ' (auto)' : '');
          c.onclick = ()=>{ cycle(h,k,weekend); render(); };
          // Habit accent outline
          c.style.outline = `1px solid ${hexToRgba(h.color, 0.25)}`;
          c.style.outlineOffset = '-1px';
          cells.appendChild(c);
        });
        row.appendChild(cells);

        elChain.appendChild(row);
      }
    }

    // Helpers
    function hexToRgba(hex, alpha){ const m=hex.replace('#',''); const v=parseInt(m.length===3? m.split('').map(c=>c+c).join('') : m, 16); const r=(v>>16)&255, g=(v>>8)&255, b=v&255; return `rgba(${r}, ${g}, ${b}, ${alpha})`; }

    // Events
    document.getElementById('newHabit').onclick = addHabit;
    document.getElementById('exportAll').onclick = ()=>{
      const data = JSON.stringify(state, null, 2);
      const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([data], {type:'application/json'})); a.download = 'habit-tracker-backup.json'; a.click(); URL.revokeObjectURL(a.href);
    };
    document.getElementById('importAll').onchange = (e)=>{
      const f = e.target.files?.[0]; if(!f) return; const r = new FileReader();
      r.onload = ()=>{ try{ state = JSON.parse(r.result); if(!state.ui) state.ui={ windowDays: 15, windowEndISO: fmt(today), theme:'light'}; save(state); render(); alert('Imported.'); }catch{ alert('Invalid JSON'); } };
      r.readAsText(f);
    };

    document.getElementById('themeToggle').onclick = ()=>{ state.ui.theme = (state.ui.theme==='light'?'dark':'light'); save(state); render(); };

    document.getElementById('prevDay').onclick = (e)=> shiftWindow(e.shiftKey ? -7 : -1);
    document.getElementById('nextDay').onclick = (e)=> shiftWindow(e.shiftKey ? +7 : +1);
    document.getElementById('todayBtn').onclick = ()=>{ state.ui.windowEndISO = fmt(today); save(state); render(); };

    // Keyboard: arrows to move window
    document.addEventListener('keydown', (e)=>{
      if(['INPUT','SELECT','TEXTAREA'].includes(document.activeElement.tagName)) return;
      if(e.key==='ArrowLeft') shiftWindow(e.shiftKey? -7 : -1);
      if(e.key==='ArrowRight') shiftWindow(e.shiftKey? +7 : +1);
    });

    // Initial render
    render();
  </script>
</body>
</html>
