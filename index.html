<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Habit Tracker â€” Everydayâ€‘style Chain</title>
  <link rel="icon" href="data:," />
  <style>
    :root{
      /* Light theme (default) */
      --bg: #f6f7fb;
      --panel: #ffffff;
      --panel-2: #fbfcff;
      --text: #0f172a;
      --muted: #64748b;
      --accent: #6b8cff; /* for generic buttons */
      --grid-gap: 8px;
      --radius: 12px;
      --shadow: 0 10px 26px rgba(2,6,23,0.08);

      /* state colors */
      --done: #22c55e;   /* green */
      --failed: #ef4444; /* red */
      --skipped: #cbd5e1;/* slate-300 */
      --pending: #e9edf6;/* pale */

      --sticky: #f3f6ff;
      --cell-size: 28px;
    }
    html[data-theme="dark"]{
      --bg: #0f1020;
      --panel: #14162b;
      --panel-2: #191b34;
      --text: #e9ecf6;
      --muted: #a7adcf;
      --done: #2dd4bf;
      --failed: #ef4444;
      --skipped: #475569;
      --pending: #2a2d4f;
      --sticky: #12142a;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; background:var(--bg); color:var(--text); font:14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji" }

    .wrap{ max-width: 1400px; margin:0 auto; padding:16px; display:flex; flex-direction:column; gap:12px }

    .card{ background: linear-gradient(180deg, var(--panel), var(--panel-2)); border-radius: var(--radius); box-shadow: var(--shadow); border:1px solid rgba(2,6,23,0.06) }

    /* Toolbar */
    .toolbar{ display:flex; gap:8px; justify-content:space-between; align-items:center; padding:12px }
    .btn{ border:1px solid rgba(2,6,23,0.12); background:#fff0; color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer }
    html[data-theme="dark"] .btn{ border-color: rgba(255,255,255,0.14) }
    .btn:hover{ border-color: rgba(2,6,23,0.25) }
    .btn.primary{ background: var(--accent); border-color: var(--accent); color:white; box-shadow: 0 6px 18px rgba(107,140,255,0.35)}
    .seg{ display:flex; gap:6px; align-items:center; flex-wrap:wrap }
    .muted{ color: var(--muted) }

    /* Chain grid */
    .chain-shell{ overflow-x:auto; overflow-y:visible; padding:10px; }
    .chain{ display:grid; grid-auto-rows: max-content; gap:8px }
    .sticky-col{ position:sticky; left:0; z-index:2; background: var(--sticky); border-right:1px solid rgba(2,6,23,0.06) }

    .head{ display:grid; align-items:end; gap: var(--grid-gap); }
    .head .label{ position:sticky; left:0; padding:10px 12px; border-radius:12px; background: var(--sticky); font-weight:700; z-index:3; }

    .dates{ display:grid; gap: var(--grid-gap); }
    .date-cell{ width: var(--cell-size); height: 20px; text-align:center; font-size:11px; color: var(--muted) }
    .date-cell.today{ font-weight:800 }

    .row{ display:grid; gap: var(--grid-gap); align-items:center }
    .habit-sticky{ display:grid; grid-template-columns: 12px minmax(80px, 1fr) max-content max-content auto; align-items:center; column-gap:10px; padding:8px 12px; border-radius:12px; box-shadow: inset 0 0 0 1px rgba(2,6,23,0.06); overflow:hidden }
    .swatch{ width:12px; height:12px; border-radius:4px; border:1px solid rgba(0,0,0,0.15) }
    .habit-name{ font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .tiny{ font-size:11px; color: var(--muted); white-space:nowrap }

    .cells{ display:grid; gap: var(--grid-gap); }
    .cell{ width: var(--cell-size); height: var(--cell-size); border-radius:8px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:1px solid rgba(2,6,23,0.06); transition: transform 120ms ease, box-shadow 120ms ease; background: var(--pending); }
    .cell:hover{ transform: translateY(-1px); box-shadow: 0 6px 14px rgba(2,6,23,0.15) }
    .cell.state-done{ background: var(--done); color:#052e1a; border-color: rgba(0,0,0,0.1) }
    .cell.state-failed{ background: var(--failed); color:white; border-color: rgba(0,0,0,0.15) }
    .cell.state-skipped{ background: var(--skipped); color:#1f2937; border-color: rgba(0,0,0,0.1) }

    /* Today status pill */
    .pill{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid rgba(2,6,23,0.08); white-space:nowrap }
    .pill.done{ background: #d6f5e3; color:#065f46; }
    .pill.failed{ background: #fee2e2; color:#991b1b; }
    .pill.skipped{ background: #e2e8f0; color:#334155; }
    .pill.pending{ background: #eef2ff; color:#363a78; }
    html[data-theme="dark"] .pill.done{ background: #124f3c; color:#d1fae5; border-color: rgba(255,255,255,0.1) }
    html[data-theme="dark"] .pill.failed{ background: #5c1a1a; color:#fecaca; border-color: rgba(255,255,255,0.1) }
    html[data-theme="dark"] .pill.skipped{ background: #303645; color:#e2e8f0; border-color: rgba(255,255,255,0.1) }
    html[data-theme="dark"] .pill.pending{ background: #1c214a; color:#dbe4ff; border-color: rgba(255,255,255,0.1) }

    .footer{ padding:10px 12px; color: var(--muted); font-size:12px }

    @media (max-width: 780px){
      .habit-sticky{ grid-template-columns: 12px 1fr auto; row-gap:6px }
      .tiny{ display:none }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card toolbar">
      <div class="seg">
        <button id="newHabit" class="btn">ï¼‹ New Habit</button>
        <button id="exportAll" class="btn">Export</button>
        <label for="importAll" class="btn">Import</label>
        <input id="importAll" type="file" accept="application/json" hidden />
      </div>
      <div class="seg">
        <span class="muted">Range:</span>
        <button data-range="30" class="btn range">30d</button>
        <button data-range="60" class="btn range">60d</button>
        <button data-range="90" class="btn range primary">90d</button>
        <button data-range="180" class="btn range">180d</button>
        <button data-range="365" class="btn range">365d</button>
        <button id="jumpToday" class="btn">Today</button>
        <button id="themeToggle" class="btn">Light â†” Dark</button>
      </div>
    </header>

    <section class="card chain-shell">
      <div id="chain" class="chain"></div>
      <div class="footer">All habits visible. Click cells to cycle: pending â†’ done â†’ failed â†’ skipped â†’ (clear). Weekends auto-skip if enabled per habit. Data stored locally.</div>
    </section>
  </div>

  <script>
    // ===== Utilities =====
    const fmt = (d)=>{ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}` };
    const parse = (s)=>{ const [y,m,d] = s.split('-').map(Number); return new Date(y, m-1, d); };
    const startOfDay = (d)=> new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const addDays = (d,n)=> new Date(d.getFullYear(), d.getMonth(), d.getDate()+n);
    const isWeekend = (d)=>{ const g=d.getDay(); return g===0 || g===6; };

    // Color helpers
    function hexToRgb(hex){ const m=hex.replace('#',''); const v=parseInt(m.length===3? m.split('').map(c=>c+c).join('') : m, 16); return {r:(v>>16)&255,g:(v>>8)&255,b:v&255}; }
    function rgbToHex(r,g,b){ return '#'+[r,g,b].map(x=> x.toString(16).padStart(2,'0')).join(''); }
    function mix(hex1, hex2, w){ const a=hexToRgb(hex1), b=hexToRgb(hex2); const r=Math.round(a.r*(1-w)+b.r*w), g=Math.round(a.g*(1-w)+b.g*w), b2=Math.round(a.b*(1-w)+b.b*w); return rgbToHex(r,g,b2); }

    // Streak shading palette for 'done'
    const BASE_DONE = '#22c55e';
    const BG_LIGHT = '#ffffff';
    const BG_DARK = '#0f1020';
    function shadeForStreak(level, theme){ // level 1..4
      const wl = [0.82, 0.62, 0.42, 0.18];
      const wd = [0.45, 0.30, 0.18, 0.05];
      const w = (theme==='dark'? wd : wl)[Math.max(0, Math.min(3, level-1))];
      const bg = theme==='dark'? BG_DARK : BG_LIGHT;
      return mix(BASE_DONE, bg, w);
    }

    // ===== Storage =====
    const KEY='habitTracker_v1';
    function load(){ try{ return JSON.parse(localStorage.getItem(KEY))||null }catch{ return null } }
    function save(x){ localStorage.setItem(KEY, JSON.stringify(x)); }

    // ===== Default State =====
    const today = startOfDay(new Date());
    const defaultState = {
      selectedHabitId: null, // retained for compatibility
      habits: [ { id: crypto.randomUUID(), name: 'Daily Focus', color:'#6b8cff', createdAt: fmt(today), autoSkipWeekends: true, entries: {} } ],
      ui: { chainDays: 90, theme: 'light' }
    };

    let state = load() || defaultState;
    if(!state.ui) state.ui = { chainDays: 90, theme: 'light' };
    if(!('chainDays' in state.ui)) state.ui.chainDays = 90;
    if(!('theme' in state.ui)) state.ui.theme = 'light';

    document.documentElement.setAttribute('data-theme', state.ui.theme);

    // ===== Elements =====
    const elChain = document.getElementById('chain');
    const elNew = document.getElementById('newHabit');
    const elExport = document.getElementById('exportAll');
    const elImport = document.getElementById('importAll');
    const elTheme = document.getElementById('themeToggle');
    const elJump = document.getElementById('jumpToday');

    const rangeBtns = Array.from(document.querySelectorAll('.btn.range'));

    // ===== Habit helpers =====
    function currentHabits(){ return state.habits; }
    function addHabit(){ state.habits.push({ id: crypto.randomUUID(), name:'New Habit', color:'#22d3ee', createdAt: fmt(today), autoSkipWeekends:true, entries:{} }); save(state); render(); }
    function deleteHabit(id){ if(!confirm('Delete this habit? This cannot be undone.')) return; state.habits = state.habits.filter(h=>h.id!==id); save(state); render(); }

    function setEntry(h, key, val){ if(!val) delete h.entries[key]; else h.entries[key]=val; save(state); }

    function cycle(h, key, weekend){
      const cur = h.entries[key] || (weekend && h.autoSkipWeekends ? 'skipped' : 'pending');
      const order=['pending','done','failed','skipped'];
      const next=order[(order.indexOf(cur)+1)%order.length];
      if(next==='pending') delete h.entries[key]; else h.entries[key]=next;
      save(state); }

    function effective(h, date){
      const k = fmt(date); const raw = h.entries[k];
      return (!raw && isWeekend(date) && h.autoSkipWeekends) ? 'skipped' : (raw || 'pending');
    }

    // ===== Stats =====
    function stats(h){
      const start = parse(h.createdAt); const end = today; let cur=0, best=0, total=0;
      for(let d=startOfDay(start); d<=end; d=addDays(d,1)){
        const v = effective(h,d);
        if(v==='done'){ cur++; total++; if(cur>best) best=cur; }
        else if(v==='skipped'){ /* keeps streak */ }
        else { if(d<today) cur=0; }
      }
      return { current:cur, longest:best, total };
    }

    function updateTodayPill(el, h){
      const v = effective(h, today);
      el.className = 'pill '+v;
      const label = v.charAt(0).toUpperCase()+v.slice(1);
      el.textContent = `Today: ${label}`;
      el.title = 'Click to cycle status for today';
      el.onclick = ()=>{ cycle(h, fmt(today), isWeekend(today)); render(); };
    }

    // ===== Render Chain =====
    function render(){
      document.documentElement.setAttribute('data-theme', state.ui.theme);
      // Header â€” date range
      const n = state.ui.chainDays;
      const dates = Array.from({length:n}, (_,i)=> addDays(today, -(n-1-i)) );

      // Grid columns: sticky + n cells
      const stickyW = 320; // wider to avoid overlap with first cell
      const gridCols = `${stickyW}px repeat(${n}, var(--cell-size))`;

      elChain.innerHTML='';

      // Head row
      const head = document.createElement('div'); head.className='head'; head.style.gridTemplateColumns = gridCols;
      const label = document.createElement('div'); label.className='label sticky-col'; label.textContent='Habits'; head.appendChild(label);
      const datesWrap = document.createElement('div'); datesWrap.className='dates'; datesWrap.style.gridTemplateColumns = `repeat(${n}, var(--cell-size))`;
      dates.forEach(d=>{
        const dc = document.createElement('div'); dc.className='date-cell';
        const isT = fmt(d)===fmt(today);
        dc.classList.toggle('today', isT);
        dc.title = d.toDateString();
        dc.textContent = d.getDate();
        datesWrap.appendChild(dc);
      });
      head.appendChild(datesWrap);
      elChain.appendChild(head);

      // Habit rows
      for(const h of currentHabits()){
        const row = document.createElement('div'); row.className='row'; row.style.gridTemplateColumns = gridCols;

        // sticky cell
        const sticky = document.createElement('div'); sticky.className='habit-sticky sticky-col';
        const sw = document.createElement('div'); sw.className='swatch'; sw.style.background = h.color; sticky.appendChild(sw);
        const name = document.createElement('div'); name.className='habit-name'; name.textContent = h.name; sticky.appendChild(name);
        const todayPill = document.createElement('span'); todayPill.className='pill'; updateTodayPill(todayPill, h); sticky.appendChild(todayPill);
        const st = stats(h);
        const tiny = document.createElement('div'); tiny.className='tiny'; tiny.textContent = `ðŸ”¥ ${st.current}  â€¢  â­ ${st.longest}  â€¢  âœ“ ${st.total}`; sticky.appendChild(tiny);
        const menu = document.createElement('button'); menu.className='btn'; menu.style.marginLeft='auto'; menu.textContent='â‹¯';
        menu.onclick = ()=> row.classList.toggle('open');
        sticky.appendChild(menu);
        row.appendChild(sticky);

        // cells
        const cells = document.createElement('div'); cells.className='cells'; cells.style.gridTemplateColumns = `repeat(${n}, var(--cell-size))`;
        let sinceBreak = 0; // counts done cells since last break (failed/past-pending). Skips don't reset.
        dates.forEach(d=>{
          const k = fmt(d); const weekend=isWeekend(d);
          const c = document.createElement('div'); c.className='cell';
          const eff = effective(h,d);
          c.classList.add('state-'+eff);

          // streak shading for DONE cells
          if(eff==='done'){
            sinceBreak += 1; const level = Math.min(4, sinceBreak);
            c.style.background = shadeForStreak(level, state.ui.theme);
          } else if(eff==='skipped'){
            // do nothing, streak continues
          } else if((eff==='failed') || (eff==='pending' && d < today)){
            sinceBreak = 0;
          }

          c.title = `${k} â€” ${eff}` + (eff==='skipped' && weekend && !h.entries[k] ? ' (auto)' : '');
          c.onclick = ()=>{ cycle(h,k,weekend); render(); };
          // Habit accent outline
          c.style.outline = `1px solid ${hexToRgba(h.color, 0.25)}`;
          c.style.outlineOffset = '-1px';
          cells.appendChild(c);
        });
        row.appendChild(cells);

        // inline editor
        const edit = document.createElement('div'); edit.className='edit';
        const form = document.createElement('div'); form.className='form';

        // name
        const nameI = document.createElement('input'); nameI.type='text'; nameI.value=h.name; nameI.placeholder='Habit name';
        nameI.onchange = ()=>{ h.name = nameI.value.trim()||'Untitled'; save(state); render(); };
        form.appendChild(nameI);

        // color
        const sel = document.createElement('select'); sel.innerHTML = `
          <option value="#6b8cff">Blue</option>
          <option value="#22d3ee">Cyan</option>
          <option value="#22c55e">Green</option>
          <option value="#a3e635">Lime</option>
          <option value="#f59e0b">Amber</option>
          <option value="#f472b6">Pink</option>
          <option value="#ef4444">Red</option>
          <option value="#a78bfa">Violet</option>`;
        sel.value = h.color; sel.onchange = ()=>{ h.color = sel.value; save(state); render(); };
        form.appendChild(sel);

        // auto-skip
        const chk = document.createElement('input'); chk.type='checkbox'; chk.checked = !!h.autoSkipWeekends; chk.id = `auto_${h.id}`;
        const lbl = document.createElement('label'); lbl.textContent='Auto-skip weekends'; lbl.htmlFor = chk.id; lbl.style.marginRight='8px';
        chk.onchange = ()=>{ h.autoSkipWeekends = !!chk.checked; save(state); render(); };
        form.appendChild(lbl); form.appendChild(chk);

        // Today quick actions
        const btnDone = document.createElement('button'); btnDone.className='btn'; btnDone.textContent='Today: Done'; btnDone.onclick=()=>{ setEntry(h, fmt(today), 'done'); render(); };
        const btnFail = document.createElement('button'); btnFail.className='btn'; btnFail.textContent='Today: Failed'; btnFail.onclick=()=>{ setEntry(h, fmt(today), 'failed'); render(); };
        const btnSkip = document.createElement('button'); btnSkip.className='btn'; btnSkip.textContent='Today: Skipped'; btnSkip.onclick=()=>{ setEntry(h, fmt(today), 'skipped'); render(); };
        const btnClear = document.createElement('button'); btnClear.className='btn'; btnClear.textContent='Today: Clear'; btnClear.onclick=()=>{ setEntry(h, fmt(today), null); render(); };
        form.appendChild(btnDone); form.appendChild(btnFail); form.appendChild(btnSkip); form.appendChild(btnClear);

        // delete
        const del = document.createElement('button'); del.className='btn'; del.textContent='Delete'; del.onclick = ()=> deleteHabit(h.id);
        form.appendChild(del);

        edit.appendChild(form);
        row.appendChild(edit);

        elChain.appendChild(row);
      }

      // highlight active range button
      rangeBtns.forEach(b=> b.classList.toggle('primary', Number(b.dataset.range)===state.ui.chainDays));
    }

    // Helpers
    function hexToRgba(hex, alpha){ const m=hex.replace('#',''); const v=parseInt(m.length===3? m.split('').map(c=>c+c).join('') : m, 16); const r=(v>>16)&255, g=(v>>8)&255, b=v&255; return `rgba(${r}, ${g}, ${b}, ${alpha})`; }

    // Events
    document.getElementById('newHabit').onclick = addHabit;
    document.getElementById('exportAll').onclick = ()=>{
      const data = JSON.stringify(state, null, 2);
      const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([data], {type:'application/json'})); a.download = 'habit-tracker-backup.json'; a.click(); URL.revokeObjectURL(a.href);
    };
    document.getElementById('importAll').onchange = (e)=>{
      const f = e.target.files?.[0]; if(!f) return; const r = new FileReader();
      r.onload = ()=>{ try{ state = JSON.parse(r.result); if(!state.ui) state.ui={chainDays:90, theme:'light'}; save(state); render(); alert('Imported.'); }catch{ alert('Invalid JSON'); } };
      r.readAsText(f);
    };

    document.getElementById('themeToggle').onclick = ()=>{ state.ui.theme = (state.ui.theme==='light'?'dark':'light'); save(state); render(); };
    rangeBtns.forEach(b=> b.onclick = ()=>{ state.ui.chainDays = Number(b.dataset.range); save(state); render(); });

    document.getElementById('jumpToday').onclick = ()=>{
      const shell = document.querySelector('.chain-shell');
      const todayCells = shell.querySelectorAll('.date-cell.today');
      if(todayCells.length){ const rect = todayCells[0].getBoundingClientRect(); const shellRect = shell.getBoundingClientRect(); shell.scrollLeft += (rect.left - shellRect.left) - shellRect.width/2 + rect.width; }
    };

    // Initial render
    render();
    // After first render, jump to today once
    setTimeout(()=> document.getElementById('jumpToday').click(), 0);
  </script>
</body>
</html>
